// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// User model - Base user account
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?   // Hashed password
  name          String
  phone         String?
  image         String?
  country       String?
  address       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // E2EE Fields
  publicKey                 String?   @db.Text
  encryptedPrivateKey       String?   @db.Text
  salt                      String?
  encryptedPrivateKeyRecovery String? @db.Text
  recoveryKeyHash           String?

  // Relations
  accounts      Account[]
  sessions      Session[]
  memberProfile Member?
  officialProfile Official?
  userRoles     UserRole[]  // Multiple roles per user
  auditLogs     AuditLog[]
  documents     Document[]
  payments      Payment[]
  
  // Relations as approver/recommender
  recommendedMembers Member[] @relation("MemberRecommender")
  approvedMembers    Member[] @relation("MemberApprover")
  
  notifications      Notification[]
  posts              Post[]
  chats              ChatParticipant[]
  messagesSent       Message[]
  promotions         Promotion[]
  burialRequests     BurialRequest[]
  siteVisits         SiteVisit[]
  approvedPromotions Promotion[] @relation("PromotionApprover")
  
  // New Relations
  occasionRequests   OccasionRequest[]
  createdMeetings    Meeting[] @relation("MeetingCreator")
  meetingAttendances MeetingAttendance[]
  meetingDocs        MeetingDoc[]
  createdProgrammes  Programme[] @relation("ProgrammeCreator")
  programmeRegistrations ProgrammeRegistration[]
  submittedReports   ProgrammeReport[]
  createdSpecialProgrammes SpecialProgramme[]
  custodianAssets    Asset[]
  createdBudgets     FinanceBudget[] @relation("BudgetCreator")
  approvedBudgets    FinanceBudget[] @relation("BudgetApprover")
  requestedFunds     FinanceFundRequest[] @relation("RequestRequester")
  recommendedFunds   FinanceFundRequest[] @relation("RequestRecommender")
  approvedFunds      FinanceFundRequest[] @relation("RequestApprover")
  disbursedFunds     FinanceFundRequest[] @relation("RequestDisburser")
  performedTransactions FinanceTransaction[]
  feeAssignments     FeeAssignment[]
  reports            Report[]
  approvedReports    Report[] @relation("ReportApprover")

  @@map("users")
}

// NextAuth required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Organization hierarchy models
model Organization {
  id          String   @id @default(cuid())
  name        String
  level       OrgLevel
  code        String   @unique // Unique code for each org (e.g., "NG", "LAG", "LAG-001")
  parentId    String?  // Self-referential for hierarchy
  parent      Organization? @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children    Organization[] @relation("OrganizationHierarchy")
  description String?  @db.Text
  address     String?
  city        String?
  state       String?
  country     String   @default("Nigeria")
  phone       String?
  email       String?
  website     String?
  welcomeMessage String? @db.Text
  welcomeImageUrl String?
  googleMapUrl String?   @db.Text
  socialLinks Json?
  
  // Planning Settings
  planningDeadlineMonth Int? @default(12)
  planningDeadlineDay   Int? @default(12)

  // CMS Fields
  missionText String?   @db.Text
  visionText  String?   @db.Text
  whatsapp    String?
  officeHours String?
  sliderImages Json?    // Array of {url, title, subtitle}

  // Paystack Subaccount Integration
  paystackSubaccountCode String?
  bankName               String?
  accountNumber          String?
  bankCode               String?

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt


  // Relations
  members     Member[]
  officials   Official[]
  userRoles   UserRole[]
  documents   Document[]
  payments    Payment[]
  posts       Post[]
  galleries     Gallery[]
  pages         Page[]
  navigationItems NavigationItem[]
  campaigns     FundraisingCampaign[]
  
  // New Relations
  occasionRequests OccasionRequest[]
  meetings         Meeting[]
  programmes       Programme[]
  specialProgrammes SpecialProgramme[]
  assets           Asset[]
  financeBudgets   FinanceBudget[]
  financeFundRequests FinanceFundRequest[]
  financeTransactions FinanceTransaction[]
  fees             Fee[]
  offices          Office[]
  reports          Report[]

  @@index([parentId])
  @@map("organizations")
}

enum OrgLevel {
  NATIONAL
  STATE
  LOCAL
  LOCAL_GOVERNMENT
  BRANCH
}

// Member model
model Member {
  id              String       @id @default(cuid())
  userId          String       @unique
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  memberId        String?      @unique // Unique membership ID
  status          MemberStatus @default(PENDING)
  membershipType MembershipType @default(REGULAR)
  dateJoined      DateTime     @default(now())
  dateExpired     DateTime?
  isActive        Boolean      @default(true)
  
  // Personal information
  dateOfBirth     DateTime?
  gender          Gender?
  occupation      String?
  address         String?
  emergencyContact String?
  emergencyPhone  String?
  
  // Additional fields
  metadata        Json?        // For flexible additional data
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Approval Workflow
  recommendationStatus RecommendationStatus @default(NONE)
  recommendedBy     String?
  recommender       User?        @relation("MemberRecommender", fields: [recommendedBy], references: [id], onDelete: SetNull)
  recommendedAt     DateTime?
  
  approvedBy        String?
  approver          User?        @relation("MemberApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  approvedAt        DateTime?
  
  rejectionReason   String?      @db.Text

  // Relations
  payments        Payment[]
  documents       Document[]
  programmeRegistrations ProgrammeRegistration[]

  @@map("members")
}

enum MemberStatus {
  PENDING
  RECOMMENDED
  ACTIVE
  SUSPENDED
  EXPIRED
  INACTIVE
  REJECTED
}

enum RecommendationStatus {
  NONE
  RECOMMENDED
  REJECTED
}

enum MembershipType {
  REGULAR
  ASSOCIATE
  HONORARY
  LIFETIME
}

enum Gender {
  MALE
  FEMALE
}

// Official model - Elected/appointed officials
model Official {
  id            String         @id @default(cuid())
  userId        String         @unique
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization  Organization   @relation(fields: [organizationId], references: [id])
  position      String         // e.g., "President", "Secretary", "Treasurer"
  positionLevel OfficialLevel
  dateElected   DateTime?
  dateAppointed DateTime?
  termStart     DateTime
  termEnd       DateTime?
  image         String?        @db.VarChar(500)
  bio           String?        @db.Text
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@map("officials")
}

enum OfficialLevel {
  NATIONAL
  STATE
  LOCAL_GOVERNMENT
  BRANCH
}

// Role model - Dynamic roles that can be created and managed
model Role {
  id            String         @id @default(cuid())
  name          String         @unique // e.g., "SuperAdmin", "National Admin", "State Admin"
  code          String         @unique // e.g., "SUPER_ADMIN", "NATIONAL_ADMIN", "STATE_ADMIN"
  description   String?        @db.Text
  jurisdictionLevel JurisdictionLevel // What level this role operates at
  isSystem      Boolean        @default(false) // System roles cannot be deleted
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  userRoles     UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

enum JurisdictionLevel {
  SYSTEM        // SuperAdmin - no jurisdiction limit
  NATIONAL      // National level
  STATE         // State level
  LOCAL_GOVERNMENT // Local Government level
  BRANCH        // Branch level
}

// Permission model - All available permissions in the system
model Permission {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "members:create", "payments:read"
  name        String
  description String?  @db.Text
  category    String   // e.g., "members", "payments", "documents"
  isActive    Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rolePermissions RolePermission[]

  @@map("permissions")
}

// Junction table: User-Role assignment with jurisdiction
model UserRole {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId        String
  role          Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  organizationId String? // Jurisdiction - which organization this role applies to
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedBy    String?  // User ID who assigned this role
  assignedAt    DateTime @default(now())
  expiresAt     DateTime? // Optional expiration
  isActive       Boolean  @default(true)
  metadata       Json?    // Additional context

  @@unique([userId, roleId, organizationId])
  @@index([userId])
  @@index([roleId])
  @@index([organizationId])
  @@map("user_roles")
}

// Junction table: Role-Permission assignment
model RolePermission {
  id          String   @id @default(cuid())
  roleId      String
  role        Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission  Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  granted     Boolean  @default(true) // Can be used to temporarily revoke
  grantedAt   DateTime @default(now())
  grantedBy   String?  // User ID who granted this permission

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// Payment model - For membership fees and donations
model Payment {
  id              String        @id @default(cuid())
  userId          String?
  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  memberId        String?       // If payment is for a member
  member          Member?       @relation(fields: [memberId], references: [id], onDelete: SetNull)
  burialRequest   BurialRequest?
  campaignId      String?
  campaign        FundraisingCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("NGN")
  status          PaymentStatus @default(PENDING)
  paymentType     PaymentType
  paystackRef     String?       @unique
  paystackResponse Json?        // Store full Paystack response
  description     String?
  metadata        Json?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  feeAssignments  FeeAssignment[]

  @@map("payments")
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentType {
  MEMBERSHIP_FEE
  RENEWAL
  DONATION
  EVENT_FEE
  BURIAL_FEE
  OTHER
}

// Document model - For storing uploaded documents
model Document {
  id            String        @id @default(cuid())
  userId        String?
  user          User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organizationId String?
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  memberId      String?       // If document belongs to a member
  member        Member?       @relation(fields: [memberId], references: [id], onDelete: SetNull)
  fileName      String
  fileType      String
  fileSize      Int           // Size in bytes
  fileUrl       String        // Cloud storage URL
  documentType  DocumentType
  description   String?
  isPublic      Boolean       @default(false)
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("documents")
}

enum DocumentType {
  ID_CARD
  CERTIFICATE
  PHOTO
  CONTRACT
  REPORT
  MINUTES
  OTHER
}

// Audit Log model - Track all system actions
model AuditLog {
  id            String   @id @default(cuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action        String   // e.g., "CREATE_MEMBER", "UPDATE_PROFILE", "DELETE_USER"
  entityType    String   // e.g., "Member", "User", "Organization"
  entityId      String?
  organizationId String?
  description   String?
  ipAddress     String?
  userAgent     String?
  metadata      Json?    // Additional context
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([organizationId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Email Log model - Track all sent emails
model EmailLog {
  id            String        @id @default(cuid())
  from          String?
  to            String
  subject       String?
  body          String?       @db.Text
  template      String?       // Template name if used
  status        EmailStatus   // Use the enum
  provider      String?       // "resend", "smtp", etc.
  providerId    String?       // Provider's message ID
  error         String?       @db.Text
  metadata      Json?
  sentAt        DateTime?
  createdAt     DateTime      @default(now())

  @@index([to])
  @@index([template])
  @@map("email_logs")
}

// --- NEW MODELS SYNCED FROM DRIZZLE ---

// Navigation Items
model NavigationItem {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  label          String
  path           String?
  parentId       String?       // Self-reference
  parent         NavigationItem? @relation("NavHierarchy", fields: [parentId], references: [id])
  children       NavigationItem[] @relation("NavHierarchy")
  order          Int           @default(0)
  type           String        @default("link") // Enum: link, dropdown, button
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId])
  @@index([parentId])
  @@map("navigation_items")
}

// Religious Centres
model AdhkarCentre {
  id             String   @id @default(cuid())
  name           String
  venue          String
  address        String   @db.Text
  time           String
  contactNumber  String?
  state          String
  lga            String
  organizationId String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("adhkar_centres")
}

model TeskiyahCentre {
  id             String   @id @default(cuid())
  name           String
  venue          String
  address        String   @db.Text
  time           String
  contactNumber  String?
  state          String
  lga            String
  branch         String?
  organizationId String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("teskiyah_centres")
}

// Occasions (Engagement)
model OccasionType {
  id             String   @id @default(cuid())
  name           String   @unique
  certificateFee Decimal? @default(0.00) @db.Decimal(10, 2)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  requests       OccasionRequest[]

  @@map("occasion_types")
}

model OccasionRequest {
  id                String       @id @default(cuid())
  userId            String
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  typeId            String
  type              OccasionType @relation(fields: [typeId], references: [id])
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id])
  date              DateTime
  time              String
  venue             String
  address           String       @db.Text
  role              String       // Enum: COORDINATING, WITNESS
  certificateNeeded Boolean      @default(false)
  status            String       @default("PENDING") // PENDING, APPROVED, COMPLETED, REJECTED
  paymentStatus     PaymentStatus @default(PENDING)
  amount            Decimal?     @default(0.00) @db.Decimal(10, 2)
  details           Json?
  certificateNo     String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@map("occasion_requests")
}

// Meetings
model Meeting {
  id             String   @id @default(cuid())
  title          String
  description    String?  @db.Text
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  scheduledAt    DateTime
  endAt          DateTime?
  venue          String?
  isOnline       Boolean  @default(false)
  meetingLink    String?  @db.VarChar(500)
  status         String   @default("SCHEDULED") // SCHEDULED, ONGOING, ENDED, CANCELLED
  createdBy      String
  creator        User     @relation("MeetingCreator", fields: [createdBy], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  attendances    MeetingAttendance[]
  docs           MeetingDoc[]

  @@index([organizationId])
  @@map("meetings")
}

model MeetingAttendance {
  id        String   @id @default(cuid())
  meetingId String
  meeting   Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String   @default("INVITED") // INVITED, ACCEPTED, DECLINED, PRESENT, ABSENT
  joinedAt  DateTime?
  leftAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([meetingId, userId])
  @@map("meeting_attendances")
}

model MeetingDoc {
  id               String   @id @default(cuid())
  meetingId        String
  meeting          Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  title            String
  url              String   @db.VarChar(500)
  type             String   @default("OTHER") // AGENDA, MINUTES, MEMBER_REPORT, OTHER
  submissionStatus String   @default("ON_TIME") // ON_TIME, LATE
  createdAt        DateTime @default(now())

  @@index([meetingId])
  @@map("meeting_docs")
}

// Programmes
model Programme {
  id                 String   @id @default(cuid())
  organizationId     String
  organization       Organization @relation(fields: [organizationId], references: [id])
  title              String
  description        String   @db.Text
  venue              String
  startDate          DateTime
  endDate            DateTime?
  time               String?
  level              String   // orgLevelEnum
  targetAudience     String?  @default("PUBLIC")
  status             String   @default("DRAFT") // DRAFT, PENDING_STATE, PENDING_NATIONAL, APPROVED, REJECTED, etc.
  
  approvedStateBy    String?
  approvedStateAt    DateTime?
  approvedNationalBy String?
  approvedNationalAt DateTime?
  
  organizingOfficeId String?
  organizingOffice   Office?  @relation(fields: [organizingOfficeId], references: [id])
  
  format             String   @default("PHYSICAL") // PHYSICAL, VIRTUAL, HYBRID
  frequency          String   @default("ONCE")
  objectives         String?  @db.Text
  budget             Decimal? @default(0.00) @db.Decimal(15, 2)
  committee          String?
  additionalInfo     String?  @db.Text
  isLateSubmission   Boolean  @default(false)
  paymentRequired    Boolean  @default(false)
  amount             Decimal? @default(0.00) @db.Decimal(10, 2)
  hasCertificate     Boolean  @default(false)
  
  createdBy          String
  creator            User     @relation("ProgrammeCreator", fields: [createdBy], references: [id])
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  registrations      ProgrammeRegistration[]
  report             ProgrammeReport?

  @@index([organizationId])
  @@map("programmes")
}

model ProgrammeRegistration {
  id               String   @id @default(cuid())
  programmeId      String
  programme        Programme @relation(fields: [programmeId], references: [id], onDelete: Cascade)
  userId           String?
  user             User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  memberId         String?
  member           Member?   @relation(fields: [memberId], references: [id], onDelete: SetNull)
  name             String
  email            String
  phone            String?
  status           String    @default("REGISTERED")
  paymentReference String?
  certificateUrl   String?   @db.VarChar(500)
  certificateIssuedAt DateTime?
  registeredAt     DateTime  @default(now())

  @@index([programmeId])
  @@map("programme_registrations")
}

model ProgrammeReport {
  id              String   @id @default(cuid())
  programmeId     String   @unique
  programme       Programme @relation(fields: [programmeId], references: [id], onDelete: Cascade)
  summary         String   @db.Text
  challenges      String?  @db.Text
  comments        String?  @db.Text
  attendeesMale   Int      @default(0)
  attendeesFemale Int      @default(0)
  amountSpent     Decimal? @default(0.00) @db.Decimal(15, 2)
  images          Json?
  submittedBy     String
  submitter       User     @relation(fields: [submittedBy], references: [id])
  submittedAt     DateTime @default(now())

  @@map("programme_reports")
}

// Special Programmes
model SpecialProgramme {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category       String   // TESKIYAH_WORKSHOP, FRIDAY_KHUTHBAH, etc.
  title          String
  description    String?  @db.Text
  summary        String?  @db.Text
  year           Int
  date           DateTime?
  imageUrl       String?  @db.VarChar(500)
  isPublished    Boolean  @default(true)
  createdBy      String
  creator        User     @relation(fields: [createdBy], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  files          SpecialProgrammeFile[]

  @@index([organizationId])
  @@map("special_programmes")
}

model SpecialProgrammeFile {
  id          String           @id @default(cuid())
  programmeId String
  programme   SpecialProgramme @relation(fields: [programmeId], references: [id], onDelete: Cascade)
  title       String
  url         String           @db.VarChar(500)
  type        String           // AUDIO, VIDEO, DOCUMENT
  order       Int              @default(0)
  createdAt   DateTime         @default(now())

  @@index([programmeId])
  @@map("special_programme_files")
}

// Assets
model Asset {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  description    String?  @db.Text
  serialNumber   String?
  category       String   // FURNITURE, ELECTRONICS, etc.
  condition      String   @default("GOOD")
  status         String   @default("ACTIVE")
  purchaseDate   DateTime?
  purchasePrice  Decimal? @default(0.00) @db.Decimal(15, 2)
  currentValue   Decimal? @default(0.00) @db.Decimal(15, 2)
  location       String?  @db.Text
  custodianId    String?
  custodian      User?    @relation(fields: [custodianId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  maintenanceLogs AssetMaintenanceLog[]

  @@index([organizationId])
  @@map("assets")
}

model AssetMaintenanceLog {
  id              String   @id @default(cuid())
  assetId         String
  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  type            String   // REPAIR, SERVICE
  description     String   @db.Text
  cost            Decimal? @default(0.00) @db.Decimal(15, 2)
  date            DateTime
  performedBy     String?
  nextServiceDate DateTime?
  createdAt       DateTime @default(now())

  @@index([assetId])
  @@map("asset_maintenance_logs")
}

// Finance
model FinanceBudget {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  year           Int
  title          String
  totalAmount    Decimal  @default(0.00) @db.Decimal(15, 2)
  status         String   @default("DRAFT")
  createdBy      String
  creator        User     @relation("BudgetCreator", fields: [createdBy], references: [id])
  approvedBy     String?
  approver       User?    @relation("BudgetApprover", fields: [approvedBy], references: [id])
  approvedAt     DateTime?
  comments       String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  items          FinanceBudgetItem[]

  @@index([organizationId])
  @@map("finance_budgets")
}

model FinanceBudgetItem {
  id          String        @id @default(cuid())
  budgetId    String
  budget      FinanceBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category    String
  description String        @db.VarChar(500)
  amount      Decimal       @db.Decimal(15, 2)
  createdAt   DateTime      @default(now())

  @@index([budgetId])
  @@map("finance_budget_items")
}

model FinanceFundRequest {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  requesterId    String
  requester      User     @relation("RequestRequester", fields: [requesterId], references: [id])
  title          String
  description    String   @db.Text
  amount         Decimal  @db.Decimal(15, 2)
  status         String   @default("PENDING")
  
  recommendedBy  String?
  recommender    User?    @relation("RequestRecommender", fields: [recommendedBy], references: [id])
  recommendedAt  DateTime?
  approvedBy     String?
  approver       User?    @relation("RequestApprover", fields: [approvedBy], references: [id])
  approvedAt     DateTime?
  disbursedBy    String?
  disburser      User?    @relation("RequestDisburser", fields: [disbursedBy], references: [id])
  disbursedAt    DateTime?

  rejectionReason String? @db.Text
  evidenceUrl     String? @db.VarChar(500)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  transaction     FinanceTransaction?

  @@index([organizationId])
  @@map("finance_fund_requests")
}

model FinanceTransaction {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id])
  type             String   // INFLOW, OUTFLOW
  amount           Decimal  @db.Decimal(15, 2)
  category         String
  description      String   @db.VarChar(500)
  performedBy      String
  performer        User     @relation(fields: [performedBy], references: [id])
  date             DateTime @default(now())
  
  relatedRequestId String?  @unique
  relatedRequest   FinanceFundRequest? @relation(fields: [relatedRequestId], references: [id])
  
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([organizationId])
  @@map("finance_transactions")
}

// Fees
model Fee {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  title          String
  description    String?  @db.Text
  amount         Decimal  @db.Decimal(10, 2)
  targetType     String   // ALL_MEMBERS, OFFICIALS
  dueDate        DateTime?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  assignments    FeeAssignment[]

  @@index([organizationId])
  @@map("fees")
}

model FeeAssignment {
  id         String   @id @default(cuid())
  feeId      String
  fee        Fee      @relation(fields: [feeId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status     String   @default("PENDING")
  amountPaid Decimal? @default(0.00) @db.Decimal(10, 2)
  paidAt     DateTime?
  paymentId  String?
  payment    Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  createdAt  DateTime @default(now())

  @@index([feeId])
  @@index([userId])
  @@map("fee_assignments")
}

// Promotions
model PromotionPlan {
  id           String   @id @default(cuid())
  name         String
  durationDays Int
  amount       Decimal  @db.Decimal(15, 2)
  description  String?  @db.Text
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  promotions   Promotion[]

  @@map("promotion_plans")
}

model Promotion {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId          String
  plan            PromotionPlan @relation(fields: [planId], references: [id])
  title           String
  imageUrl        String        @db.VarChar(500)
  link            String?       @db.VarChar(500)
  status          String        @default("PENDING") // PENDING, APPROVED, REJECTED, ACTIVE, EXPIRED
  paymentStatus   String        @default("PENDING")
  amount          Decimal       @db.Decimal(15, 2)
  startDate       DateTime?
  endDate         DateTime?
  approvedBy      String?
  approver        User?         @relation("PromotionApprover", fields: [approvedBy], references: [id])
  approvedAt      DateTime?
  rejectionReason String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@map("promotions")
}

// Burial
model BurialRequest {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deceasedName    String
  relationship    String
  causeOfDeath    String
  dateOfDeath     DateTime
  placeOfDeath    String
  contactPhone    String
  contactEmail    String
  status          String   @default("PENDING")
  rejectionReason String?  @db.Text
  paymentId       String?  @unique
  payment         Payment? @relation(fields: [paymentId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  certificate     BurialCertificate?

  @@map("burial_requests")
}

model BurialCertificate {
  id                String        @id @default(cuid())
  burialRequestId   String        @unique
  burialRequest     BurialRequest @relation(fields: [burialRequestId], references: [id], onDelete: Cascade)
  certificateNumber String        @unique
  issuedAt          DateTime?     @default(now())
  issuedBy          String?
  pdfUrl            String?       @db.VarChar(500)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@map("burial_certificates")
}

// Pages
model Page {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  slug           String
  title          String
  content        String?  @db.Text
  isPublished    Boolean  @default(false)
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, slug])
  @@map("pages")
}

// System Settings
model SystemSetting {
  id           String           @id @default(cuid())
  settingKey   String           @unique @db.VarChar(100)
  settingValue String?          @db.Text
  category     SettingsCategory
  isEncrypted  Boolean          @default(false)
  description  String?          @db.VarChar(500)
  updatedBy    String?          @db.VarChar(255)
  updatedAt    DateTime         @updatedAt
  createdAt    DateTime         @default(now())

  @@map("system_settings")
}

model EmailTemplate {
  id          String   @id @default(cuid())
  templateKey String   @unique @db.VarChar(100)
  name        String
  subject     String
  htmlBody    String   @db.Text
  textBody    String?  @db.Text
  variables   Json?
  description String?  @db.VarChar(500)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("email_templates")
}

model SiteVisit {
  id        String   @id @default(cuid())
  visitorId String   @db.VarChar(255)
  sessionId String   @db.VarChar(255)
  path      String   @db.VarChar(500)
  userId    String?  @db.VarChar(255)
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userAgent String?  @db.Text
  ip        String?  @db.VarChar(255)
  createdAt DateTime @default(now())

  @@map("site_visits")
}


enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

// Notification model - In-app notifications
model Notification {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title         String
  message       String   @db.Text
  type          NotificationType @default(INFO)
  isRead        Boolean  @default(false)
  actionUrl     String?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum PostType {
  NEWS
  EVENT
  ANNOUNCEMENT
}

model Post {
  id          String   @id @default(cuid())
  organizationId String
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  title       String
  slug        String   @unique
  excerpt     String?  @db.Text
  content     String   @db.Text
  coverImage  String?
  postType    PostType @default(NEWS)
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([organizationId])
  @@map("posts")
}

model Gallery {
  id          String   @id @default(cuid())
  organizationId String
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  title       String
  description String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  images      GalleryImage[]

  @@index([organizationId])
  @@map("galleries")
}

model GalleryImage {
  id          String   @id @default(cuid())
  galleryId   String
  gallery     Gallery  @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  imageUrl    String
  caption     String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([galleryId])
  @@map("gallery_images")
}

// Chat System Models


model Chat {
  id          String   @id @default(cuid())
  name        String?  // Null for 1-on-1 chats
  isGroup     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants ChatParticipant[]
  messages     Message[]

  @@map("chats")
}

model ChatParticipant {
  id        String   @id @default(cuid())
  chatId    String
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isAdmin   Boolean  @default(false) // For group chats
  joinedAt  DateTime @default(now())

  @@unique([chatId, userId])
  @@map("chat_participants")
}

model Message {
  id        String   @id @default(cuid())
  chatId    String
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  senderId  String
  sender    User     @relation(fields: [senderId], references: [id])
  content   String?  @db.Text
  mediaUrl  String?
  readBy    Json?    // Array of user IDs or map of ID -> timestamp
  createdAt DateTime @default(now())

  @@index([chatId])
  @@index([senderId])
  @@map("messages")
}



enum CampaignStatus {
  PENDING
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}




model FundraisingCampaign {
  id            String   @id @default(cuid())
  organizationId String
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  title         String
  slug          String
  description   String?  @db.Text
  targetAmount  Decimal  @default(0.00) @db.Decimal(15, 2)
  raisedAmount  Decimal  @default(0.00) @db.Decimal(15, 2)
  startDate     DateTime @default(now())
  endDate       DateTime?
  status        CampaignStatus @default(ACTIVE)
  coverImage    String?
  allowCustomAmount Boolean @default(true)
  suggestedAmounts Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  donations     Payment[]

  @@unique([organizationId, slug])
  @@map("fundraising_campaigns")
}



// ID Generation Tables (Matched to Drizzle Schema)
model JurisdictionCode {
  id        String   @id @default(cuid())
  type      JurisdictionType
  name      String
  code      String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("jurisdiction_codes")
}

model MemberIdSequence {
  key        String   @id
  lastSerial Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@map("member_id_sequences")
}

enum JurisdictionType {
  COUNTRY
  STATE
}



// Offices
model Office {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  description    String?       @db.Text
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  reports        Report[]
  programmes     Programme[]

  @@map("offices")
}

// Reports
model Report {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  officeId       String?
  office         Office?       @relation(fields: [officeId], references: [id])
  type           String        // reportTypeEnum
  status         String        @default("DRAFT")
  title          String
  period         String
  content        Json
  approvedBy     String?
  approver       User?         @relation("ReportApprover", fields: [approvedBy], references: [id])
  approvedAt     DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("reports")
}

enum SettingsCategory {
  EMAIL
  NOTIFICATION
  GENERAL
  AI
}
